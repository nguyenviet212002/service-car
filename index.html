<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8" />
  <title>Đặt xe tải – Giao diện kiểu Lalamove (Văn Cường)</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

  <style>
    :root {
      --orange: #ff6b00;
      --orange-soft: #fff5ec;
      --orange-border: #ffd2af;
      --gray-bg: #f7f7f8;
      --card-bg: #ffffff;
      --border: #e4e4e7;
      --text-main: #111827;
      --text-sub: #6b7280;
      --green: #22c55e;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #ffffff;
      color: var(--text-main);
    }

    /* TOP NAV (giống Lalamove) */
    .top-nav {
      height: 56px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 24px;
    }

    .top-nav-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 16px;
      font-weight: 700;
      color: var(--orange);
    }

    .brand-logo {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background: var(--orange);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-weight: 800;
      font-size: 18px;
    }

    .nav-tabs {
      display: flex;
      align-items: center;
      gap: 24px;
      margin-left: 24px;
      font-size: 14px;
    }

    .nav-tab {
      position: relative;
      padding: 4px 0;
      cursor: pointer;
      color: #9ca3af;
      font-weight: 500;
    }

    .nav-tab.active {
      color: var(--orange);
    }

    .nav-tab.active::after {
      content: "";
      position: absolute;
      left: 0;
      right: 0;
      bottom: -17px;
      height: 2px;
      background: var(--orange);
      border-radius: 999px;
    }

    .top-nav-right {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 13px;
    }

    .btn-link-shopify {
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 6px 16px;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      cursor: pointer;
    }

    .btn-link-shopify span.icon {
      width: 18px;
      height: 18px;
      border-radius: 4px;
      background: var(--green);
    }

    /* MAIN LAYOUT */
    .layout {
      display: flex;
      height: calc(100vh - 56px);
    }

    .sidebar {
      width: 420px;
      max-width: 100%;
      border-right: 1px solid var(--border);
      background: var(--gray-bg);
      display: flex;
      flex-direction: column;
    }

    .sidebar-inner {
      padding: 16px 20px 20px;
      height: 100%;
      overflow-y: auto;
    }

    .map-wrapper {
      flex: 1;
    }

    #map {
      width: 100%;
      height: 100%;
    }

    /* ROUTE PANEL */
    .panel {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 14px 16px 16px;
      border: 1px solid var(--border);
      box-shadow: 0 4px 12px rgba(15, 23, 42, 0.04);
    }

    .panel-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-sub);
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .panel-title span {
      font-weight: 500;
    }

    .panel-title small {
      color: #9ca3af;
    }

    .route-step {
      padding: 8px 0;
      display: flex;
      align-items: flex-start;
      gap: 8px;
    }

    .step-dot {
      width: 18px;
      display: flex;
      justify-content: center;
    }

    .step-dot span {
      width: 9px;
      height: 9px;
      border-radius: 999px;
      border: 2px solid #d1d5db;
      background: #fff;
    }

    .step-dot.pick span {
      border-color: var(--orange);
    }

    .step-dot.drop span {
      border-color: #111827;
    }

    .step-line {
      width: 2px;
      background: #e5e7eb;
      margin: 2px auto 0;
      height: 18px;
    }

    .step-body {
      flex: 1;
    }

    .step-label {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 4px;
      color: var(--text-sub);
    }

    .field-row {
      display: flex;
      gap: 6px;
    }

    .field-row input[type="text"] {
      flex: 1;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid var(--border);
      font-size: 13px;
      outline: none;
      transition: border-color 0.15s, box-shadow 0.15s;
      background: #f9fafb;
    }

    .field-row input[type="text"]:focus {
      border-color: #60a5fa;
      box-shadow: 0 0 0 1px rgba(59, 130, 246, 0.25);
      background: #ffffff;
    }

    .btn-mini {
      border-radius: 8px;
      border: 1px solid var(--border);
      background: #fff;
      padding: 0 10px;
      font-size: 12px;
      cursor: pointer;
      white-space: nowrap;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .btn-mini.main {
      border-color: var(--orange);
      color: var(--orange);
    }

    .btn-mini:hover {
      background: #f3f4f6;
    }

    .btn-location {
      margin-top: 6px;
      font-size: 12px;
      background: transparent;
      border: none;
      color: #2563eb;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .btn-location span.icon {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      border: 2px solid #2563eb;
    }

    /* suggestions */
    .suggestions {
      position: relative;
    }

    .suggest-box {
      position: absolute;
      top: 32px;
      left: 0;
      right: 0;
      background: #fff;
      border-radius: 8px;
      border: 1px solid var(--border);
      box-shadow: 0 8px 20px rgba(15, 23, 42, 0.1);
      z-index: 30;
      max-height: 180px;
      overflow-y: auto;
      display: none;
      font-size: 13px;
    }

    .suggest-box.show {
      display: block;
    }

    .suggest-item {
      padding: 7px 9px;
      cursor: pointer;
      border-bottom: 1px solid #f3f4f6;
    }

    .suggest-item:last-child {
      border-bottom: none;
    }

    .suggest-item:hover {
      background: #f3f4ff;
    }

    .suggest-main {
      font-weight: 600;
    }

    .suggest-sub {
      font-size: 12px;
      color: #6b7280;
    }

    /* ADD STOP */
    .add-stop {
      margin-top: 4px;
      font-size: 13px;
      color: #ef4444;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .add-stop span.circle {
      width: 16px;
      height: 16px;
      border-radius: 999px;
      border: 1px solid #ef4444;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 13px;
    }

    /* VEHICLE SECTION */
    .section-title {
      margin-top: 18px;
      margin-bottom: 10px;
      font-size: 13px;
      font-weight: 600;
      color: var(--text-sub);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .vehicle-list {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
    }

    .vehicle-card {
      border-radius: 12px;
      border: 1px solid var(--border);
      background: #fff;
      padding: 10px 10px 9px;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      gap: 4px;
      transition: border-color 0.15s, box-shadow 0.15s, background 0.15s;
    }

    .vehicle-card:hover {
      border-color: #f97316;
    }

    .vehicle-card.active {
      border-color: #fb923c;
      background: var(--orange-soft);
      box-shadow: 0 4px 12px rgba(249, 115, 22, 0.25);
    }

    .vehicle-icon {
      width: 28px;
      height: 18px;
      border-radius: 3px;
      background: var(--orange);
      margin-bottom: 4px;
    }

    .vehicle-name {
      font-size: 13px;
      font-weight: 600;
    }

    .vehicle-info {
      font-size: 11px;
      color: #6b7280;
    }

    .vehicle-price {
      margin-top: 2px;
      font-size: 12px;
      color: #ef4444;
      font-weight: 600;
    }

    /* INFO BOX */
    .info-box {
      margin-top: 16px;
      padding: 10px 11px;
      background: #fefce8;
      border-radius: 10px;
      border: 1px solid #facc15;
      font-size: 12px;
      color: #854d0e;
    }

    .info-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 3px;
    }

    .info-row span.label {
      color: #6b7280;
    }

    .info-row span.value {
      font-weight: 600;
      color: #111827;
    }

    .btn-submit {
      margin-top: 12px;
      width: 100%;
      border-radius: 999px;
      border: none;
      background: var(--orange);
      color: #fff;
      font-size: 14px;
      font-weight: 600;
      padding: 10px 0;
      cursor: pointer;
      box-shadow: 0 6px 18px rgba(249, 115, 22, 0.35);
    }

    .btn-submit:hover {
      filter: brightness(1.03);
    }

    @media (max-width: 900px) {
      .layout {
        flex-direction: column;
        height: auto;
      }

      .sidebar {
        width: 100%;
        height: auto;
        border-right: none;
        border-bottom: 1px solid var(--border);
      }

      .map-wrapper {
        height: 60vh;
      }
    }
  </style>
</head>

<body>
  <!-- TOP NAV -->
  <div class="top-nav">
    <div class="top-nav-left">
      <div class="brand">
        <div class="brand-logo">V</div>
       
      </div>
      <div class="nav-tabs">
        <div class="nav-tab active">Đặt giao hàng</div>
        <div class="nav-tab">Đơn hàng</div>
        <div class="nav-tab">Thanh toán &amp; Coupon</div>
        <div class="nav-tab">Tài xế</div>
        <div class="nav-tab">Phần thưởng</div>
      </div>
    </div>

  </div>

  <!-- MAIN LAYOUT -->
  <div class="layout">
    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="sidebar-inner">
        <div class="panel" id="routePanel">
          <div class="panel-title">
            <span>Lộ trình <small>(tối đa 20 điểm dừng – demo 2 điểm)</small></span>
          </div>

          <!-- ĐIỂM LẤY HÀNG -->
          <div class="route-step">
            <div class="step-dot pick">
              <span></span>
              <div class="step-line"></div>
            </div>
            <div class="step-body">
              <div class="step-label">Địa điểm lấy hàng</div>
              <div class="field-row suggestions" id="pickupGroup">
                <input type="text" id="pickupInput" placeholder="Nhập địa chỉ lấy hàng" autocomplete="off" />
                <button class="btn-mini main" type="button" onclick="searchAddress('pickup')">Tìm</button>
                <button class="btn-mini" type="button" onclick="enableClickMode('pickup')">Chọn map</button>

                <div class="suggest-box" id="pickupSuggest"></div>
              </div>
              <button class="btn-location" type="button" onclick="useMyLocation()">
                <span class="icon"></span> Dùng vị trí của tôi
              </button>
            </div>
          </div>

          <!-- ĐIỂM TRẢ HÀNG -->
          <div class="route-step">
            <div class="step-dot drop">
              <span></span>
            </div>
            <div class="step-body">
              <div class="step-label">Địa điểm trả hàng</div>
              <div class="field-row suggestions" id="dropGroup">
                <input type="text" id="dropInput" placeholder="Nhập địa chỉ trả hàng" autocomplete="off" />
                <button class="btn-mini main" type="button" onclick="searchAddress('drop')">Tìm</button>
                <button class="btn-mini" type="button" onclick="enableClickMode('drop')">Chọn map</button>

                <div class="suggest-box" id="dropSuggest"></div>
              </div>
            </div>
          </div>

          <!-- Thêm điểm dừng – chỉ giao diện -->
          <div class="route-step">
            <div class="step-dot">
              <!-- rỗng -->
            </div>
            <div class="step-body">
              <div class="add-stop">
                <span class="circle">+</span> Thêm điểm dừng (demo chưa xử lý)
              </div>
            </div>
          </div>

          <!-- hidden inputs -->
          <input type="hidden" id="pickupLat" />
          <input type="hidden" id="pickupLng" />
          <input type="hidden" id="dropLat" />
          <input type="hidden" id="dropLng" />

          <!-- PHƯƠNG TIỆN -->
          <div class="section-title">Phương tiện (xe tải)</div>
          <div class="vehicle-list" id="vehicleList">
            <div class="vehicle-card active" data-id="truck500">
              <div class="vehicle-icon"></div>
              <div class="vehicle-name">Xe tải 500 kg</div>
              <div class="vehicle-info">Thùng nhỏ – phù hợp hàng nhẹ, ít kiện</div>
              <div class="vehicle-price">Phí từ 30.000đ + 10.000đ/km</div>
            </div>

            <div class="vehicle-card" data-id="truck1000">
              <div class="vehicle-icon"></div>
              <div class="vehicle-name">Xe tải 1 tấn</div>
              <div class="vehicle-info">Phù hợp chuyển nhà mini, shop nhỏ</div>
              <div class="vehicle-price">Phí từ 50.000đ + 12.000đ/km</div>
            </div>

            <div class="vehicle-card" data-id="truck2000">
              <div class="vehicle-icon"></div>
              <div class="vehicle-name">Xe tải 2 tấn</div>
              <div class="vehicle-info">Chở hàng số lượng vừa, pallet</div>
              <div class="vehicle-price">Phí từ 80.000đ + 14.000đ/km</div>
            </div>

            <div class="vehicle-card" data-id="truck5000">
              <div class="vehicle-icon"></div>
              <div class="vehicle-name">Xe tải 5 tấn</div>
              <div class="vehicle-info">Hàng cồng kềnh, số lượng lớn</div>
              <div class="vehicle-price">Phí từ 150.000đ + 18.000đ/km</div>
            </div>
          </div>

          <!-- THÔNG TIN CHUYẾN -->
          <div class="info-box" id="tripInfo">
            Nhập điểm lấy hàng &amp; điểm trả hàng, chọn loại xe tải để hệ thống tính quãng đường và giá tạm tính.
          </div>

          <button id="btnRequest" class="btn-submit" type="button" onclick="submitBooking()">
            Gửi yêu cầu giao hàng
          </button>
        </div>
      </div>
    </aside>

    <!-- MAP -->
    <div class="map-wrapper">
      <div id="map"></div>
    </div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <script>
    // ===== CONFIG CHUNG =====
    const HOME_CENTER = [21.02, 105.85]; // Hà Nội
    const VIEWBOX = "105.3,21.5,106.4,20.5"; // khu vực Hà Nội – Hưng Yên – Bắc Ninh
    const NOMINATIM_BASE =
      "https://nominatim.openstreetmap.org/search?format=json&addressdetails=1" +
      "&countrycodes=vn&viewbox=" + VIEWBOX + "&bounded=1";

    // Xe tải – base fee + price/km
    const TRUCK_TYPES = {
      truck500: { name: "Xe tải 500 kg", base: 30000, perKm: 10000 },
      truck1000: { name: "Xe tải 1 tấn", base: 50000, perKm: 12000 },
      truck2000: { name: "Xe tải 2 tấn", base: 80000, perKm: 14000 },
      truck5000: { name: "Xe tải 5 tấn", base: 150000, perKm: 18000 },
    };
    let selectedVehicleId = "truck500";

    // ===== KHỞI TẠO MAP =====
    const map = L.map("map").setView(HOME_CENTER, 11);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: "&copy; OpenStreetMap contributors",
    }).addTo(map);

    const pickupIcon = L.icon({
      iconUrl: "https://cdn-icons-png.flaticon.com/128/14703/14703768.png",
      iconSize: [40, 40],
      iconAnchor: [20, 20],
    });

    const dropIcon = L.icon({
      iconUrl: "https://cdn-icons-png.flaticon.com/512/684/684908.png",
      iconSize: [34, 34],
      iconAnchor: [17, 34],
    });

    let pickupMarker = null;
    let dropMarker = null;
    let routeLine = null;
    let clickMode = null;

    const pickupInput = document.getElementById("pickupInput");
    const dropInput = document.getElementById("dropInput");
    const pickupLat = document.getElementById("pickupLat");
    const pickupLng = document.getElementById("pickupLng");
    const dropLat = document.getElementById("dropLat");
    const dropLng = document.getElementById("dropLng");
    const tripInfo = document.getElementById("tripInfo");

    const pickupSuggestBox = document.getElementById("pickupSuggest");
    const dropSuggestBox = document.getElementById("dropSuggest");

    // ===== AUTOCOMPLETE =====
    let typingPickup = null;
    let typingDrop = null;

    pickupInput.addEventListener("input", () => {
      clearTimeout(typingPickup);
      const val = pickupInput.value.trim();
      if (val.length < 3) {
        pickupSuggestBox.classList.remove("show");
        return;
      }
      typingPickup = setTimeout(() => {
        querySuggestions(val, "pickup");
      }, 350);
    });

    dropInput.addEventListener("input", () => {
      clearTimeout(typingDrop);
      const val = dropInput.value.trim();
      if (val.length < 3) {
        dropSuggestBox.classList.remove("show");
        return;
      }
      typingDrop = setTimeout(() => {
        querySuggestions(val, "drop");
      }, 350);
    });

    pickupInput.addEventListener("keydown", e => {
      if (e.key === "Enter") {
        e.preventDefault();
        searchAddress("pickup");
      }
    });

    dropInput.addEventListener("keydown", e => {
      if (e.key === "Enter") {
        e.preventDefault();
        searchAddress("drop");
      }
    });

    function querySuggestions(q, type) {
      const url = NOMINATIM_BASE + "&limit=5&q=" + encodeURIComponent(q);
      fetch(url)
        .then(res => res.json())
        .then(data => {
          const box = (type === "pickup") ? pickupSuggestBox : dropSuggestBox;
          box.innerHTML = "";
          if (!data.length) {
            box.classList.remove("show");
            return;
          }
          data.forEach(item => {
            const div = document.createElement("div");
            div.className = "suggest-item";
            div.dataset.lat = item.lat;
            div.dataset.lon = item.lon;
            div.dataset.display = item.display_name;

            const main = document.createElement("div");
            main.className = "suggest-main";
            main.textContent = item.display_name.split(",")[0];

            const sub = document.createElement("div");
            sub.className = "suggest-sub";
            sub.textContent = item.display_name.replace(main.textContent + ",", "");

            div.appendChild(main);
            div.appendChild(sub);

            div.addEventListener("click", () => {
              const lat = parseFloat(div.dataset.lat);
              const lon = parseFloat(div.dataset.lon);
              map.setView([lat, lon], 15);
              if (type === "pickup") {
                setPickup(lat, lon, div.dataset.display);
                pickupInput.value = div.dataset.display;
              } else {
                setDrop(lat, lon, div.dataset.display);
                dropInput.value = div.dataset.display;
              }
              box.classList.remove("show");
            });

            box.appendChild(div);
          });
          box.classList.add("show");
        })
        .catch(err => console.error(err));
    }

    // Ẩn gợi ý khi click ngoài
    document.addEventListener("click", (e) => {
      if (!document.getElementById("pickupGroup").contains(e.target)) {
        pickupSuggestBox.classList.remove("show");
      }
      if (!document.getElementById("dropGroup").contains(e.target)) {
        dropSuggestBox.classList.remove("show");
      }
    });

    // ===== VỊ TRÍ CỦA TÔI =====
    function useMyLocation() {
      if (!navigator.geolocation) {
        alert("Trình duyệt không hỗ trợ lấy vị trí.");
        return;
      }
      navigator.geolocation.getCurrentPosition(
        pos => {
          const lat = pos.coords.latitude;
          const lon = pos.coords.longitude;
          map.setView([lat, lon], 15);
          setPickup(lat, lon, "Vị trí của tôi");
          pickupInput.value = "Vị trí của tôi (" +
            lat.toFixed(5) + ", " + lon.toFixed(5) + ")";
        },
        err => {
          console.error(err);
          alert("Không lấy được vị trí. Hãy bật GPS/quyền vị trí.");
        }
      );
    }

    // ===== CHỌN TRÊN MAP =====
    function enableClickMode(type) {
      clickMode = type;
      // alert("Nhấp vào bản đồ để chọn " +
      //   (type === "pickup" ? "ĐIỂM LẤY HÀNG" : "ĐIỂM TRẢ HÀNG"));
    }

    map.on("click", (e) => {
      if (!clickMode) return;
      const { lat, lng } = e.latlng;
      const label = (clickMode === "pickup" ? "Lấy hàng" : "Trả hàng") +
        " (chọn trên map): " + lat.toFixed(5) + ", " + lng.toFixed(5);

      if (clickMode === "pickup") {
        setPickup(lat, lng, label);
        pickupInput.value = label;
      } else {
        setDrop(lat, lng, label);
        dropInput.value = label;
      }
      clickMode = null;
    });

    // ===== GEOCODING NÚT TÌM =====
    function searchAddress(type) {
      const q = type === "pickup"
        ? pickupInput.value.trim()
        : dropInput.value.trim();
      if (!q) {
        alert("Nhập địa chỉ trước đã.");
        return;
      }
      const url = NOMINATIM_BASE + "&limit=1&q=" + encodeURIComponent(q);
      fetch(url)
        .then(res => res.json())
        .then(data => {
          if (!data.length) {
            alert("Không tìm thấy địa chỉ, thử cụ thể hơn.");
            return;
          }
          const lat = parseFloat(data[0].lat);
          const lon = parseFloat(data[0].lon);
          map.setView([lat, lon], 15);
          if (type === "pickup") {
            setPickup(lat, lon, data[0].display_name);
            pickupInput.value = data[0].display_name;
          } else {
            setDrop(lat, lon, data[0].display_name);
            dropInput.value = data[0].display_name;
          }
        })
        .catch(err => {
          console.error(err);
          alert("Có lỗi khi tìm địa chỉ.");
        });
    }

    // ===== ĐẶT MARKER =====
    function setPickup(lat, lng, label) {
      if (pickupMarker) map.removeLayer(pickupMarker);
      pickupMarker = L.marker([lat, lng], { icon: pickupIcon, draggable: true })
        .addTo(map);
      pickupMarker.bindPopup("Điểm lấy hàng<br>" + label).openPopup();
      pickupLat.value = lat;
      pickupLng.value = lng;

      pickupMarker.on("dragend", e => {
        const pos = e.target.getLatLng();
        pickupLat.value = pos.lat;
        pickupLng.value = pos.lng;
        pickupInput.value = "Lấy hàng (kéo): " +
          pos.lat.toFixed(5) + ", " + pos.lng.toFixed(5);
        updateRoute();
      });

      updateRoute();
    }

    function setDrop(lat, lng, label) {
      if (dropMarker) map.removeLayer(dropMarker);
      dropMarker = L.marker([lat, lng], { icon: dropIcon, draggable: true })
        .addTo(map);
      dropMarker.bindPopup("Điểm trả hàng<br>" + label).openPopup();
      dropLat.value = lat;
      dropLng.value = lng;

      dropMarker.on("dragend", e => {
        const pos = e.target.getLatLng();
        dropLat.value = pos.lat;
        dropLng.value = pos.lng;
        dropInput.value = "Trả hàng (kéo): " +
          pos.lat.toFixed(5) + ", " + pos.lng.toFixed(5);
        updateRoute();
      });

      updateRoute();
    }

    // ===== VẼ ROUTE OSRM =====
    function updateRoute() {
      if (!pickupLat.value || !dropLat.value) {
        tripInfo.innerHTML =
          "Nhập điểm lấy & điểm trả, hệ thống sẽ tính quãng đường và giá tạm tính cho loại xe tải bạn chọn.";
        if (routeLine) {
          map.removeLayer(routeLine);
          routeLine = null;
        }
        return;
      }

      const lat1 = parseFloat(pickupLat.value);
      const lng1 = parseFloat(pickupLng.value);
      const lat2 = parseFloat(dropLat.value);
      const lng2 = parseFloat(dropLng.value);
      const url = `https://router.project-osrm.org/route/v1/driving/${lng1},${lat1};${lng2},${lat2}?overview=full&geometries=geojson`;
      fetch(url)
        .then(res => res.json())
        .then(data => {
          if (!data.routes || !data.routes.length) {
            tripInfo.innerHTML =
              "Không tính được tuyến đường (OSRM). Thử chọn điểm gần đường hơn.";
            return;
          }
          const route = data.routes[0];
          distanceKm = route.distance / 1000;
          const durationMin = route.duration / 60;
          const coords = route.geometry.coordinates.map(c => [c[1], c[0]]);

          if (routeLine) map.removeLayer(routeLine);
          routeLine = L.polyline(coords, {
            color: "#ff6b00",
            weight: 5,
            opacity: 0.9
          }).addTo(map);
          map.fitBounds(routeLine.getBounds(), { padding: [30, 30] });

          const vehicle = TRUCK_TYPES[selectedVehicleId];
          const price = vehicle.base + vehicle.perKm * distanceKm;
          const roundedPrice =
            Math.round(price / 1000) * 1000; // làm tròn nghìn

          tripInfo.innerHTML = `
            <div class="info-row">
              <span class="label">Loại xe:</span>
              <span class="value">${vehicle.name}</span>
            </div>
            <div class="info-row">
              <span class="label">Quãng đường ước tính:</span>
              <span class="value">${distanceKm.toFixed(2)} km</span>
            </div>
            <div class="info-row">
              <span class="label">Thời gian dự kiến:</span>
              <span class="value">${durationMin.toFixed(0)} phút</span>
            </div>
            <div class="info-row">
              <span class="label">Giá tạm tính:</span>
              <span class="value">${roundedPrice.toLocaleString("vi-VN")} đ</span>
            </div>
            <div style="font-size:11px;margin-top:4px;">
              Tuyến đường được tính theo mạng lưới đường bộ thực tế (OSRM). Giá chỉ mang tính tham khảo, chưa bao gồm phí bốc xếp, chờ, phụ phí cầu đường.
            </div>
          `;

        })
        .catch(err => {
          console.error(err);
          tripInfo.innerHTML = "Có lỗi khi tính tuyến đường. Thử lại sau.";
        });
    }



    // ===== CHỌN XE TẢI =====
    const vehicleListEl = document.getElementById("vehicleList");
    vehicleListEl.addEventListener("click", (e) => {
      const card = e.target.closest(".vehicle-card");
      if (!card) return;
      const id = card.dataset.id;
      if (!TRUCK_TYPES[id]) return;

      selectedVehicleId = id;

      document
        .querySelectorAll(".vehicle-card")
        .forEach(el => el.classList.remove("active"));
      card.classList.add("active");

      updateRoute();
    });


  </script>
  <script>
    const API_URL = "http://localhost/map/api.php";

    async function submitBooking(payload) {
      try {

        const res = await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
          
        });

        if (!res.ok) throw new Error("HTTP " + res.status);

        const data = await res.json();
        // console.log("Server response:", data);
        alert("Đặt thành công, mã đơn: " + data.order_code);
      } catch (err) {
        alert("Gửi lên server thất bại!");
      }
    }
    document.getElementById("btnRequest").addEventListener("click", () => {
      // tạo data sẽ gửi
      if (!pickupLat.value || !dropLat.value) {
        tripInfo.innerHTML =
          "Nhập điểm lấy & điểm trả, hệ thống sẽ tính quãng đường và giá tạm tính cho loại xe tải bạn chọn.";
        if (routeLine) {
          map.removeLayer(routeLine);
          routeLine = null;
        }
        return;
      }

      const lat1 = parseFloat(pickupLat.value);
      const lng1 = parseFloat(pickupLng.value);
      const lat2 = parseFloat(dropLat.value);
      const lng2 = parseFloat(dropLng.value);
      const url = `https://router.project-osrm.org/route/v1/driving/${lng1},${lat1};${lng2},${lat2}?overview=full&geometries=geojson`;
      fetch(url)
        .then(res => res.json())
        .then(data => {
          if (!data.routes || !data.routes.length) {
            tripInfo.innerHTML =
              "Không tính được tuyến đường (OSRM). Thử chọn điểm gần đường hơn.";
            return;
          }
          const route = data.routes[0];
          distanceKm = route.distance / 1000;
          durationMin = route.duration / 60;
        })
        const vehicle = TRUCK_TYPES[selectedVehicleId];
        const price = vehicle.base + vehicle.perKm * distanceKm;
      // const vehicle = TRUCK_TYPES[selectedVehicleId];
      const payload = {
        pickup: pickupInput.value,
        dropoff: dropInput.value,
        distance_km: distanceKm,
        price: price,
        vehicle: vehicle.name,
        // thêm info khách:
        // customer: {
        //   name:  document.getElementById("customerName").value || "viet",
        //   phone: document.getElementById("customerPhone").value || "0968893421",
        // },
      };

      submitBooking(payload);   // ✅ TRUYỀN payload vào
    });

  </script>
</body>

</html>
